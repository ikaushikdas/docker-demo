pipeline {
    agent any

    enviroments {
        CI = true
        ARTIFACTORY_ACCESS_TOKEN = credentials('artifactory-token')
    }
    stages {
        stage('preparation') {
            steps {
                git 'https://github.com/ikaushikdas/docker-demo.git'
            }
        }
        stage('build') {
            steps {
              
                nodejs(nodeJSInstallationName: 'nodejs') {
                    sh 'npm install'
                    sh 'npm run test'                 

                }
                //sh 'cd ${pwd}'
                sh 'tar -czvf node-app.tar.gz ./test node_modules package.json index-db.js index.js'
            }
        }
        stage('Upload to Artifact'){
           agent {
             
                docker{
                    image 'docker.bintray.io/jfrog/artifactory-pro:latest'
                    reuseNode true
                }
            }
            steps{
                sh 'jf rt u --url https://devopsdemoartifact.jfrog.io/artifactory --access-token ${ARTIFACTORY_ACCESS_TOKEN} ./node-app.tar.gz node-app-npm/'
            }  

        }
    }
}

